TOP := $(srctree)/drivers/gpu/sprd/rogue/driver

PVRSRV_MODNAME := pvrsrvkm
PVRSYNC_MODNAME := pvr_sync

BOARD_NAME := roc1
CACHEFLUSH_NO_KMRBF_USING_UMVA := 1
PVR_SYSTEM := rgx_sprd
NO_HARDWARE := 0

PVR_DRM_NAME := pvr
BUILD := release
PVR_BUILD_DIR := $(TOP)/build/linux

KERNEL_PATH := kernel4.14
SUPPORT_SERVER_SYNC_IMPL := 1
SUPPORT_RGX := 1
PVRSRV_ENABLE_SYNC_POISONING := 1
PVRSRV_ENABLE_CCCB_UTILISATION_INFO_VERBOSE := 1
PVRSRV_ENABLE_CCCB_UTILISATION_INFO := 1
HWR_DEFAULT_ENABLED := 1
RGX_FW_SIGNED := 1
PVR_DVFS := 1
PVR_USE_FENCE_SYNC_MODEL := 1
PVR_HANDLE_BACKEND := idr

ccflags-y += -DSUPPORT_SERVER_SYNC_IMPL=1
ccflags-y += -DSUPPORT_RGX=1
ccflags-y += -DPVRSRV_MODNAME=\"$(PVRSRV_MODNAME)\"
ccflags-y += -DPVRSYNC_MODNAME=\"$(PVRSYNC_MODNAME)\"
ccflags-y += -DRELEASE
ccflags-y += -DPVR_BUILD_TYPE=\"$(BUILD)\"
ccflags-y += -DPVR_BUILD_DIR=\"$(PVR_BUILD_DIR)\"
ccflags-y += -DPVR_DRM_NAME=\"$(PVR_DRM_NAME)\"
ccflags-y += -DPVRSRV_ENABLE_CCCB_UTILISATION_INFO=1
ccflags-y += -DPVRSRV_ENABLE_CCCB_UTILISATION_INFO_THRESHOLD=90
ccflags-y += -DRGX_FW_FILENAME=\"rgx.fw.signed\"
ccflags-y += -DFEATURE_PVR_DVFS=1
ccflags-y += -DPVR_DVFS=1
ccflags-y += -DSUPPORT_NATIVE_FENCE_SYNC=1
ccflags-y += -DPVR_USE_FENCE_SYNC_MODEL=1
ccflags-y += -DPVRSRV_SYNC_CHECKPOINT_CCB=1

RGX_BVNC := 24.50.208.504
RGX_BNC_SPLIT := $(subst .,$(space) ,$(RGX_BVNC))
RGX_BNC := $(word 1,$(RGX_BNC_SPLIT)).V.$(word 3,$(RGX_BNC_SPLIT)).$(word 4,$(RGX_BNC_SPLIT))

RGX_BVNC_CORE_KM := $(TOP)/hwdefs/km/cores/rgxcore_km_$(RGX_BVNC).h
ccflags-y += -DRGX_BVNC_CORE_KM_HEADER=\"cores/rgxcore_km_$(RGX_BVNC).h\"

RGX_BNC_CONFIG_KM := $(TOP)/hwdefs/km/configs/rgxconfig_km_$(RGX_BNC).h
ccflags-y += -DRGX_BNC_CONFIG_KM_HEADER=\"configs/rgxconfig_km_$(RGX_BNC).h\"

ccflags-y += -DPVRSRV_FULL_SYNC_TRACKING_HISTORY_LEN=256

ccflags-y += -DPVRSRV_RGX_LOG2_CLIENT_CCB_SIZE_TQ2D=16
ccflags-y += -DPVRSRV_RGX_LOG2_CLIENT_CCB_SIZE_TQ3D=16
ccflags-y += -DPVRSRV_RGX_LOG2_CLIENT_CCB_SIZE_CDM=16
ccflags-y += -DPVRSRV_RGX_LOG2_CLIENT_CCB_SIZE_TA=16
ccflags-y += -DPVRSRV_RGX_LOG2_CLIENT_CCB_SIZE_3D=16
ccflags-y += -DPVRSRV_RGX_LOG2_CLIENT_CCB_SIZE_KICKSYNC=16
ccflags-y += -DPVRSRV_RGX_LOG2_CLIENT_CCB_MAX_SIZE_TQ2D=16
ccflags-y += -DPVRSRV_RGX_LOG2_CLIENT_CCB_MAX_SIZE_TQ3D=16
ccflags-y += -DPVRSRV_RGX_LOG2_CLIENT_CCB_MAX_SIZE_CDM=16
ccflags-y += -DPVRSRV_RGX_LOG2_CLIENT_CCB_MAX_SIZE_TA=16
ccflags-y += -DPVRSRV_RGX_LOG2_CLIENT_CCB_MAX_SIZE_3D=16
ccflags-y += -DPVRSRV_RGX_LOG2_CLIENT_CCB_MAX_SIZE_KICKSYNC=16

ccflags-y += -DPVR_DIRTY_BYTES_FLUSH_THRESHOLD=524288

ccflags-y += -DPVR_LDM_DRIVER_REGISTRATION_NAME=\"$(PVRSRV_MODNAME)\"

ccflags-y += -DPVR_LINUX_HIGHORDER_ALLOCATION_THRESHOLD=256
ccflags-y += -DPVR_LINUX_PHYSMEM_MAX_ALLOC_ORDER_NUM=2
ccflags-y += -DPVR_LINUX_KMALLOC_ALLOCATION_THRESHOLD=16384

ccflags-y += -DPVRSRV_APPHINT_GENERAL_NON4K_HEAP_PAGE_SIZE=0x4000
ccflags-y += -DPVRSRV_APPHINT_HWRDEBUGDUMPLIMIT=APPHNT_BLDVAR_DBGDUMPLIMIT
ccflags-y += -DPVRSRV_APPHINT_ENABLETRUSTEDDEVICEACECONFIG=IMG_FALSE
ccflags-y += -DPVRSRV_APPHINT_CLEANUPTHREADPRIORITY=5
ccflags-y += -DPVRSRV_APPHINT_WATCHDOGTHREADPRIORITY=0
ccflags-y += -DPVRSRV_APPHINT_HWPERFCLIENTBUFFERSIZE=786432
ccflags-y += -DPVRSRV_APPHINT_ENABLESIGNATURECHECKS=APPHNT_BLDVAR_ENABLESIGNATURECHECKS
ccflags-y += -DPVRSRV_APPHINT_SIGNATURECHECKSBUFSIZE=RGXFW_SIG_BUFFER_SIZE_MIN
ccflags-y += -DPVRSRV_APPHINT_BIFTILINGMODE=4
ccflags-y += -DPVRSRV_APPHINT_DISABLECLOCKGATING=0
ccflags-y += -DPVRSRV_APPHINT_DISABLEDMOVERLAP=0
ccflags-y += -DPVRSRV_APPHINT_ENABLECDMKILLINGRANDMODE=0
ccflags-y += -DPVRSRV_APPHINT_ENABLEFWCONTEXTSWITCH=RGXFWIF_INICFG_CTXSWITCH_DM_ALL
ccflags-y += -DPVRSRV_APPHINT_VDMCONTEXTSWITCHMODE=RGXFWIF_INICFG_VDM_CTX_STORE_MODE_INDEX
ccflags-y += -DPVRSRV_APPHINT_ENABLERDPOWERISLAND=RGX_RD_POWER_ISLAND_DEFAULT
ccflags-y += -DPVRSRV_APPHINT_DRIVERMODE=0x7FFFFFFF
ccflags-y += -DPVRSRV_APPHINT_FIRMWAREPERF=FW_PERF_CONF_NONE
ccflags-y += -DPVRSRV_APPHINT_FWCONTEXTSWITCHPROFILE=RGXFWIF_CTXSWITCH_PROFILE_MEDIUM_EN
ccflags-y += -DPVRSRV_APPHINT_HWPERFDISABLECUSTOMCOUNTERFILTER=0
ccflags-y += -DPVRSRV_APPHINT_HWPERFFWBUFSIZEINKB=2048
ccflags-y += -DPVRSRV_APPHINT_HWPERFHOSTBUFSIZEINKB=2048
ccflags-y += -DPVRSRV_APPHINT_HWPERFHOSTTHREADTIMEOUTINMS=50
ccflags-y += -DPVRSRV_APPHINT_JONESDISABLEMASK=0
ccflags-y += -DPVRSRV_APPHINT_NEWFILTERINGMODE=1
ccflags-y += -DPVRSRV_APPHINT_TRUNCATEMODE=0
ccflags-y += -DPVRSRV_APPHINT_USEMETAT1=RGX_META_T1_OFF
ccflags-y += -DPVRSRV_APPHINT_EMUMAXFREQ=0
ccflags-y += -DPVRSRV_APPHINT_GPIOVALIDATIONMODE=0
ccflags-y += -DPVRSRV_APPHINT_RGXBVNC=\"$(RGX_BVNC)\"
ccflags-y += -DGPUVIRT_VALIDATION_NUM_OS=8
ccflags-y += -DGPUVIRT_VALIDATION_NUM_REGIONS=2
ccflags-y += -DSUPPORT_RGXFW_STATS_FRAMEWORK
ccflags-y += -DPVRSRV_APPHINT_OSIDREGION0MIN=\"0x00000000\ 0x04000000\ 0x10000000\ 0x18000000\ 0x20000000\ 0x28000000\ 0x30000000\ 0x38000000\"
ccflags-y += -DPVRSRV_APPHINT_OSIDREGION0MAX=\"0x3FFFFFFF\ 0x0FFFFFFF\ 0x17FFFFFF\ 0x1FFFFFFF\ 0x27FFFFFF\ 0x2FFFFFFF\ 0x37FFFFFF\ 0x3FFFFFFF\"
ccflags-y += -DPVRSRV_APPHINT_OSIDREGION1MIN=\"0x3F000000\ 0x3F000000\ 0x3F000000\ 0x3F000000\ 0x3F000000\ 0x3F000000\ 0x3F000000\ 0x3F000000\"
ccflags-y += -DPVRSRV_APPHINT_OSIDREGION1MAX=\"0x3FFFFFFF\ 0x3FFFFFFF\ 0x3FFFFFFF\ 0x3FFFFFFF\ 0x3FFFFFFF\ 0x3FFFFFFF\ 0x3FFFFFFF\ 0x3FFFFFFF\"
ccflags-y += -DPVRSRV_APPHINT_HTBUFFERSIZE=64
ccflags-y += -DPVRSRV_APPHINT_VALIDATEIRQ=0
ccflags-y += -DPVRSRV_APPHINT_FWTRACEBUFSIZEINDWORDS=RGXFW_TRACE_BUF_DEFAULT_SIZE_IN_DWORDS
ccflags-y += -DPVRSRV_APPHINT_ENABLEFULLSYNCTRACKING=IMG_FALSE
ccflags-y += -DPVRSRV_APPHINT_ENABLEPAGEFAULTDEBUG=IMG_FALSE
ccflags-y += -DPVRSRV_APPHINT_IGNOREHWREPORTEDBVNC=IMG_FALSE
ccflags-y += -DPVRSRV_APPHINT_PHYSMEMTESTPASSES=APPHNT_PHYSMEMTEST_ENABLE
ccflags-y += -DPVRSRV_APPHINT_FBCDCVERSIONOVERRIDE=0
ccflags-y += -DPVRSRV_APPHINT_ENABLEHTBLOGGROUP=0
ccflags-y += -DPVRSRV_APPHINT_HTBOPERATIONMODE=HTB_OPMODE_DROPOLDEST
ccflags-y += -DPVRSRV_APPHINT_ENABLEFTRACEGPU=IMG_FALSE
ccflags-y += -DPVRSRV_APPHINT_HWPERFFWFILTER=0
ccflags-y += -DPVRSRV_APPHINT_HWPERFHOSTFILTER=0
ccflags-y += -DPVRSRV_APPHINT_HWPERFCLIENTFILTER_SERVICES=0
ccflags-y += -DPVRSRV_APPHINT_HWPERFCLIENTFILTER_EGL=0
ccflags-y += -DPVRSRV_APPHINT_HWPERFCLIENTFILTER_OPENGLES=0
ccflags-y += -DPVRSRV_APPHINT_HWPERFCLIENTFILTER_OPENCL=0
ccflags-y += -DPVRSRV_APPHINT_HWPERFCLIENTFILTER_VULKAN=0
ccflags-y += -DPVRSRV_APPHINT_CACHEOPCONFIG=0
ccflags-y += -DPVRSRV_APPHINT_CACHEOPGFTHRESHOLDSIZE=0
ccflags-y += -DPVRSRV_APPHINT_CACHEOPUMKMHRESHOLDSIZE=0
ccflags-y += -DPVRSRV_APPHINT_TIMECORRCLOCK=0
ccflags-y += -DPVRSRV_APPHINT_ASSERTONHWRTRIGGER=IMG_FALSE
ccflags-y += -DPVRSRV_APPHINT_ASSERTOUTOFMEMORY=IMG_FALSE
ccflags-y += -DPVRSRV_APPHINT_CHECKMLIST=APPHNT_BLDVAR_DEBUG
ccflags-y += -DPVRSRV_APPHINT_DISABLEFEDLOGGING=IMG_FALSE
ccflags-y += -DPVRSRV_APPHINT_ENABLEAPM=RGX_ACTIVEPM_DEFAULT
ccflags-y += -DPVRSRV_APPHINT_ENABLEHTBLOGGROUP=0
ccflags-y += -DPVRSRV_APPHINT_ENABLELOGGROUP=RGXFWIF_LOG_TYPE_NONE
ccflags-y += -DPVRSRV_APPHINT_FIRMWARELOGTYPE=0
ccflags-y += -DPVRSRV_APPHINT_ZEROFREELIST=IMG_FALSE
ccflags-y += -DPVRSRV_APPHINT_DUSTREQUESTINJECT=IMG_FALSE
ccflags-y += -DPVRSRV_APPHINT_DISABLEPDUMPPANIC=IMG_FALSE
ccflags-y += -DPVRSRV_APPHINT_ENABLEFWPOISONONFREE=IMG_FALSE
ccflags-y += -DPVRSRV_APPHINT_FWPOISONONFREEVALUE=0xBD

ccflags-y += -DPVR_ANNOTATION_MAX_LEN=63

ccflags-y += -DPVRSRV_POISON_ON_ALLOC_VALUE=0xd9
ccflags-y += -DPVRSRV_POISON_ON_FREE_VALUE=0x63

ccflags-y += -DRGX_FW_HEAP_SHIFT=25
ccflags-y += -DRGX_INITIAL_SLR_HOLDOFF_PERIOD_MS=0

ccflags-y += -DPVRSRV_NEED_PVR_DPF=1

ccflags-y += -DPVR_LDM_PLATFORM_PRE_REGISTERED
ccflags-y += -DSUPPORT_MMU_PAGESIZECONFIG_REFCOUNT
ccflags-y += -DPVRSRV_RESET_ON_HWTIMEOUT

export is_at_least_lollipop_mr1 := 1
export is_at_least_marshmallow := 1
export is_at_least_nougat := 1
export is_at_least_nougat_mr1 := 1
export is_at_least_oreo := 1
export is_at_least_oreo_mr1 := 1
export is_at_least_pie := 1
export is_at_least_q := 1

ccflags-y += -DLINUX
ccflags-y += -D__KERNEL__
ccflags-y += \
    -I$(TOP)/hwdefs \
    -I$(TOP)/hwdefs/km \
    -I$(TOP)/include \
    -I$(TOP)/include/drm \
    -I$(TOP)/include/public \
    -I$(TOP)/services/include \
    -I$(TOP)/services/include/shared \
	-I$(TOP)/services/server/devices/rgx \
	-I$(TOP)/services/server/env/linux \
	-I$(TOP)/services/server/include \
    -I$(TOP)/services/shared/include \
    -I$(TOP)/services/shared/devices/rgx \
    -I$(TOP)/services/system/$(PVR_SYSTEM) \
	-I$(TOP)/services/system/include \
	-I$(TOP)/generated/cache_bridge \
	-I$(TOP)/generated/cmm_bridge \
	-I$(TOP)/generated/devicememhistory_bridge \
	-I$(TOP)/generated/dmabuf_bridge \
	-I$(TOP)/generated/htbuffer_bridge \
	-I$(TOP)/generated/mm_bridge \
	-I$(TOP)/generated/pdump_bridge \
	-I$(TOP)/generated/pdumpctrl_bridge \
	-I$(TOP)/generated/pdumpmm_bridge \
	-I$(TOP)/generated/pvrtl_bridge \
	-I$(TOP)/generated/rgxbreakpoint_bridge \
	-I$(TOP)/generated/rgxcmp_bridge \
	-I$(TOP)/generated/rgxfwdbg_bridge \
	-I$(TOP)/generated/rgxhwperf_bridge \
	-I$(TOP)/generated/rgxkicksync_bridge \
	-I$(TOP)/generated/rgxpdump_bridge \
	-I$(TOP)/generated/rgxregconfig_bridge \
	-I$(TOP)/generated/rgxsignals_bridge \
	-I$(TOP)/generated/rgxtq2_bridge \
	-I$(TOP)/generated/rgxtq_bridge \
	-I$(TOP)/generated/rgxta3d_bridge \
	-I$(TOP)/generated/ri_bridge \
	-I$(TOP)/generated/srvcore_bridge \
	-I$(TOP)/generated/sync_bridge \
	-I$(TOP)/generated/synctracking_bridge

include $(TOP)/build/linux/common/android/roc1/features.mk
include $(TOP)/services/server/env/linux/Kbuild.mk

obj-$(CONFIG_SPRD_GPU_POWERVR) += $(PVRSRV_MODNAME).o
